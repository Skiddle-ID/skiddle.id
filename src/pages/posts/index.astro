---
export const prerender = false;

import { getPosts } from '~/atproto/getPosts';
import Shell from '~/layouts/shell.astro';
import FormattedDate from '~/components/formatted-date.astro';

const q = (Astro.url.searchParams.get('q') || '').trim().toLowerCase();
const posts = await getPosts(Astro.locals, '', false);
const postsFilteredBase = posts.filter(p => !p.content?.startsWith('NOT_LIVE'));
const postsFiltered = q
  ? postsFilteredBase.filter(p => {
      const title = (p.title || '').toLowerCase();
      const content = (p.content || '').toLowerCase();
      return title.includes(q) || content.includes(q);
    })
  : postsFilteredBase;

const postsShortened = postsFiltered.map(p => {
  if (p.content?.length! > 200) {
    p.content = p.content?.slice(0, 200).trimEnd() + '...';
  }
  return p;
});
---
<Shell title="Skiddle@web ~/posts">
  <div class="mx-auto max-w-2xl flex flex-col">
    <header class="flex flex-col">
      <h1 class="font-bold before-hash-1">Posts</h1>
      <p class="text-base03">
        { q && (<>
          Showing {postsFiltered.length} result{postsFiltered.length === 1 ? '' : 's'} for "{q}".
        </>) }
        { !q && (<>Showing {postsFilteredBase.length} posts.</>) }
      </p>
    </header>

    <div class="flex flex-col divide-y divide-muted">
      {postsShortened.map((post) => (
        <div class="py-4">
          <article>
            <header>
              <h2 class="text-[var(--color-primary)] font-bold">
                <a href={`/posts/${post.rkey}/`}>{post.title}</a>
              </h2>
              <p class="text-base03">
                <span class="date">
                  <FormattedDate date={new Date(Date.parse(post.createdAt))} />
                </span>
              </p>
            </header>
          </article>

          <section class="post__summary prose max-w-6xl">
              { post.content }
          </section>
        </div>
      ))}
    </div>
  </div>
</Shell>
